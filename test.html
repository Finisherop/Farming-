<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mreward PRO - Connection Test</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f0f2f5;
    }
    
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .test-item {
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #ccc;
    }
    
    .success {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    
    .error {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    
    .info {
      background: #e3f2fd;
      border-left-color: #2196f3;
      color: #0d47a1;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px;
      font-size: 14px;
    }
    
    button:hover {
      background: #5a67d8;
    }
    
    #log {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
    }
  </style>
</head>

<body>
  <div class="test-container">
    <h1>ðŸ”§ Mreward PRO - System Test & Debug</h1>
    <p>This page will test Firebase connection and basic functionality.</p>
    
    <div class="test-item info" id="firebase-status">
      ðŸ”„ Testing Firebase connection...
    </div>
    
    <div class="test-item info" id="auth-status">
      ðŸ”„ Testing authentication...
    </div>
    
    <div class="test-item info" id="database-status">
      ðŸ”„ Testing database connection...
    </div>
    
    <div style="margin: 20px 0;">
      <h3>Quick Tests:</h3>
      <button onclick="testSignUp()">Test Sign Up</button>
      <button onclick="testSignIn()">Test Sign In</button>
      <button onclick="testAddTask()">Test Add Task</button>
      <button onclick="testReadTasks()">Test Read Tasks</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="log"></div>
  </div>

  <script>
    let auth, db;
    
    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }
    
    function clearLog() {
      document.getElementById('log').textContent = '';
    }
    
    function updateStatus(elementId, message, success = true) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `test-item ${success ? 'success' : 'error'}`;
    }
    
    // Initialize Firebase
    try {
      const firebaseConfig = {
        apiKey: "AIzaSyBNT7CLJ6QCcsFD_lhcrru3UOEqLmiYc3E",
        authDomain: "mreward-5e36d.firebaseapp.com",
        projectId: "mreward-5e36d",
        storageBucket: "mreward-5e36d.firebasestorage.app",
        messagingSenderId: "207849836641",
        appId: "1:207849836641:web:3229c8d3805338fdf49a20"
      };
      
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      
      updateStatus('firebase-status', 'âœ… Firebase initialized successfully');
      log('âœ… Firebase initialized successfully');
      
    } catch (error) {
      updateStatus('firebase-status', 'âŒ Firebase initialization failed: ' + error.message, false);
      log('âŒ Firebase initialization failed: ' + error.message, 'error');
    }
    
    // Test Auth State
    if (auth) {
      auth.onAuthStateChanged(user => {
        if (user) {
          updateStatus('auth-status', `âœ… User signed in: ${user.email}`);
          log(`âœ… User signed in: ${user.email}`);
        } else {
          updateStatus('auth-status', 'ðŸ”“ No user signed in');
          log('ðŸ”“ No user signed in');
        }
      });
    }
    
    // Test Database Connection
    if (db) {
      db.enableNetwork().then(() => {
        updateStatus('database-status', 'âœ… Firestore connected');
        log('âœ… Firestore connected successfully');
        
        // Test read access
        db.collection('tasks').limit(1).get().then(snapshot => {
          log(`âœ… Database read test successful. Found ${snapshot.size} tasks`);
        }).catch(error => {
          log(`âš ï¸ Database read test failed: ${error.message}`, 'error');
        });
        
      }).catch(error => {
        updateStatus('database-status', 'âŒ Firestore connection failed: ' + error.message, false);
        log('âŒ Firestore connection failed: ' + error.message, 'error');
      });
    }
    
    // Test Functions
    async function testSignUp() {
      const email = `test${Date.now()}@example.com`;
      const password = 'test123456';
      
      log(`ðŸ§ª Testing sign up with: ${email}`);
      
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        log(`âœ… Sign up successful: ${cred.user.uid}`);
        
        // Test user document creation
        await db.collection('users').doc(cred.user.uid).set({
          email: email,
          coins: 1000,
          testAccount: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        log('âœ… User document created successfully');
        
        // Clean up
        await cred.user.delete();
        log('âœ… Test account deleted');
        
      } catch (error) {
        log(`âŒ Sign up test failed: ${error.message}`, 'error');
      }
    }
    
    async function testSignIn() {
      log('ðŸ§ª Testing sign in with existing account...');
      
      try {
        // This will fail if no account exists, which is expected
        await auth.signInWithEmailAndPassword('admin@mreward.com', 'admin123');
        log('âœ… Sign in successful');
      } catch (error) {
        if (error.code === 'auth/user-not-found') {
          log('â„¹ï¸ No admin account found (expected for new setup)');
        } else {
          log(`âŒ Sign in test failed: ${error.message}`, 'error');
        }
      }
    }
    
    async function testAddTask() {
      log('ðŸ§ª Testing add task functionality...');
      
      const taskData = {
        title: 'Test Task - ' + Date.now(),
        desc: 'This is a test task created by debug script',
        coins: 25,
        type: 'simple',
        active: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        const docRef = await db.collection('tasks').add(taskData);
        log(`âœ… Task added successfully with ID: ${docRef.id}`);
        
        // Clean up - delete the test task
        await docRef.delete();
        log('âœ… Test task cleaned up');
        
      } catch (error) {
        log(`âŒ Add task test failed: ${error.message}`, 'error');
        
        if (error.code === 'permission-denied') {
          log('ðŸ’¡ Tip: Check your Firestore security rules', 'error');
        }
      }
    }
    
    async function testReadTasks() {
      log('ðŸ§ª Testing read tasks functionality...');
      
      try {
        const snapshot = await db.collection('tasks').limit(5).get();
        log(`âœ… Read tasks successful. Found ${snapshot.size} tasks`);
        
        if (snapshot.size > 0) {
          snapshot.forEach(doc => {
            const data = doc.data();
            log(`   ðŸ“‹ Task: ${data.title} (${data.coins} coins)`);
          });
        } else {
          log('   ðŸ“‹ No tasks found in database');
        }
        
      } catch (error) {
        log(`âŒ Read tasks test failed: ${error.message}`, 'error');
      }
    }
    
    // Run initial tests
    setTimeout(() => {
      log('ðŸš€ Starting automatic tests...');
      testReadTasks();
    }, 2000);
  </script>
</body>
</html>