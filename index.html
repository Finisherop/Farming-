<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mreward PRO ‚Äî Premium Rewards App</title>
  
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  
  <style>
:root {
  --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --card: #ffffff;
  --muted: #6b7280;
  --accent: #3b82f6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --radius: 16px;
  --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

* {
  box-sizing: border-box;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
  background: var(--bg);
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  padding: 20px;
  padding-bottom: 120px;
}

#app {
  width: 100%;
  max-width: 420px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  padding: 16px;
  border-radius: var(--radius);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.brand {
  display: flex;
  gap: 12px;
  align-items: center;
}

.logo {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  display: grid;
  place-items: center;
  color: #fff;
  font-weight: 800;
  font-size: 18px;
  box-shadow: 0 8px 16px rgba(255, 107, 107, 0.3);
}

.h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: white;
}

.subtitle {
  color: rgba(255, 255, 255, 0.8);
  font-size: 12px;
  font-weight: 500;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.small {
  font-size: 13px;
  color: var(--muted);
}

.form-row {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}

.input {
  padding: 14px;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  font-size: 14px;
  transition: all 0.3s ease;
}

.input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn {
  padding: 14px 20px;
  border-radius: 12px;
  border: none;
  background: var(--accent);
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn:hover {
  background: #2563eb;
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
}

.btn.ghost {
  background: transparent;
  color: var(--accent);
  border: 2px solid var(--accent);
}

.btn.ghost:hover {
  background: var(--accent);
  color: white;
}

.btn.success {
  background: var(--success);
}

.btn.success:hover {
  background: #059669;
}

.list {
  max-height: 300px;
  overflow: auto;
  padding-right: 8px;
}

.list::-webkit-scrollbar {
  width: 4px;
}

.list::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 2px;
}

.list::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 2px;
}

.list-item {
  padding: 16px;
  border-radius: 12px;
  border: 1px solid rgba(0, 0, 0, 0.06);
  margin-bottom: 12px;
  background: #fafafa;
  transition: all 0.3s ease;
}

.list-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.ref-code {
  padding: 16px;
  border-radius: 12px;
  background: linear-gradient(135deg, #f0f7ff, #e0f2fe);
  border: 2px solid rgba(59, 130, 246, 0.2);
  font-weight: 700;
  letter-spacing: 3px;
  text-align: center;
  font-size: 18px;
  color: var(--accent);
}

.profile-row {
  display: flex;
  gap: 16px;
  align-items: center;
}

.avatar {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: grid;
  place-items: center;
  color: #fff;
  font-weight: 700;
  font-size: 24px;
  box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
}

.ad-box {
  display: flex;
  justify-content: center;
  padding: 8px;
}

/* Modal for offerwall */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal {
  width: 95%;
  max-width: 800px;
  background: var(--card);
  border-radius: var(--radius);
  padding: 12px;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
  height: 85vh;
  display: flex;
  flex-direction: column;
}

.modal .modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid #e5e7eb;
}

.modal .modal-body {
  flex: 1;
  overflow: hidden;
  border-radius: 12px;
  margin-top: 12px;
}

.modal iframe {
  width: 100%;
  height: 100%;
  border: 0;
  border-radius: 12px;
}

.modal .close-btn {
  background: #f3f4f6;
  border-radius: 8px;
  padding: 8px 12px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
}

.modal .close-btn:hover {
  background: #e5e7eb;
}

/* Toast notifications */
#toast {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 100px;
  background: #1f2937;
  color: #fff;
  padding: 12px 20px;
  border-radius: 12px;
  display: none;
  z-index: 1100;
  font-weight: 500;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

/* Bottom navigation - Enhanced */
.bottom-nav {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 16px;
  width: 95%;
  max-width: 400px;
  display: flex;
  gap: 4px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  z-index: 1200;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.bottom-nav .tab {
  flex: 1;
  padding: 12px 8px;
  border-radius: 16px;
  text-align: center;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  transition: all 0.3s ease;
  color: var(--muted);
}

.bottom-nav .tab.active {
  background: var(--accent);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
}

/* Stats cards */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.stat-card {
  background: linear-gradient(135deg, #667eea, #764ba2);
  padding: 16px;
  border-radius: 12px;
  color: white;
  text-align: center;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 12px;
  opacity: 0.9;
}

/* Responsive design */
@media (max-width: 480px) {
  :root {
    --radius: 12px;
  }
  
  body {
    padding: 16px;
    padding-bottom: 100px;
  }
  
  .header {
    padding: 12px;
  }
  
  .card {
    padding: 16px;
  }
  
  .bottom-nav {
    width: 100%;
    margin: 0 16px;
  }
  </style>
  
  <!-- User ad scripts -->
  <script type="text/javascript">
    atOptions = {
      'key': 'dcd1fe8af5a9b6b3ea85f25d84751980',
      'format': 'iframe',
      'height': 50,
      'width': 320,
      'params': {}
    };
  </script>
  <script type="text/javascript" src="//www.highperformanceformat.com/dcd1fe8af5a9b6b3ea85f25d84751980/invoke.js"></script>
  <script type="text/javascript" src="https://singingfiles.com/script_include.php?id=1847459"></script>
</head>

<body>
  <div id="app">
    <header class="header">
      <div class="brand">
        <div class="logo">MR</div>
        <div>
          <h1 class="h1">Mreward PRO</h1>
          <div class="subtitle">Premium rewards platform ‚ú®</div>
        </div>
      </div>
      <div id="user-area"></div>
    </header>

    <div id="content-area">
      <!-- Authentication Panel -->
      <div id="auth-panel" class="card" style="display:none">
        <h3 style="margin:0 0 16px 0">üîê Sign in / Sign up</h3>
        <div class="form-row">
          <input id="email" class="input" placeholder="Enter your email" type="email" />
          <input id="password" class="input" placeholder="Password (min 6 chars)" type="password" />
          <div style="display:flex;gap:12px">
            <button id="signin-btn" class="btn">üöÄ Sign In</button>
            <button id="signup-btn" class="btn ghost">üìù Sign Up</button>
          </div>
          <div id="auth-msg" class="small" style="min-height:20px"></div>
        </div>
      </div>

      <!-- Tasks Tab Panel -->
      <div id="tasks" class="tab-panel">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value"><span id="coin-balance">0</span></div>
            <div class="stat-label">üí∞ Total Coins</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="daily-status">üéÅ</div>
            <div class="stat-label">Daily Reward</div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 12px 0">üéÅ Daily Reward</h3>
          <p class="small">Claim your daily bonus coins once every 24 hours.</p>
          <div style="margin-top:12px">
            <button id="claim-daily" class="btn success">üéÅ Claim Daily Reward</button>
            <div id="daily-msg" class="small" style="margin-top:12px"></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 12px 0">üéØ Available Tasks</h3>
          <p class="small">Complete tasks and surveys to earn coins instantly.</p>
          <div id="tasks-list" class="list" style="margin-top:12px">
            <div class="small">Loading available tasks...</div>
          </div>
          <div class="ad-box">
            <div id="top-ad"></div>
          </div>
        </div>
      </div>

      <!-- Referral Tab Panel -->
      <div id="referral" class="tab-panel" style="display:none">
        <div class="card">
          <h3 style="margin:0 0 12px 0">ü§ù Referral Program</h3>
          <p class="small">Invite friends and earn bonus coins for each successful referral.</p>

          <div style="margin-top:16px">
            <div class="small" style="margin-bottom:8px">Your Referral Code:</div>
            <div style="display:flex;gap:12px;align-items:center">
              <div class="ref-code" id="ref-code">LOADING</div>
              <button id="copy-ref" class="btn ghost">üìã Copy</button>
            </div>
          </div>

          <div style="margin-top:16px">
            <div class="small" style="margin-bottom:12px">Share your referral:</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <button class="btn ghost" id="share-wa">üì± WhatsApp</button>
              <button class="btn ghost" id="share-tg">‚úàÔ∏è Telegram</button>
            </div>
            <div style="margin-top:12px">
              <button class="btn" id="open-offerwall">üéØ Open Offerwall</button>
            </div>
          </div>

          <div style="margin-top:16px" class="card" style="background:#f8fafc">
            <div class="small" style="text-align:center">
              üí° Earn 100 coins for each friend who joins with your code!
            </div>
          </div>
        </div>
      </div>

      <!-- Withdrawal Tab Panel -->
      <div id="withdraw" class="tab-panel" style="display:none">
        <div class="card">
          <h3 style="margin:0 0 12px 0">üí∏ Request Withdrawal</h3>
          <p class="small">Convert your coins to real money through various payment methods.</p>
          
          <div style="margin-top:16px">
            <div class="stats-grid">
              <div class="card" style="text-align:center;margin:0;padding:16px">
                <div><strong>üí≥ UPI</strong></div>
                <div class="small">Min: 2000 coins (‚Çπ200)</div>
                <button class="btn withdraw-btn" data-method="UPI" data-min="2000" style="margin-top:8px">Withdraw</button>
              </div>
              <div class="card" style="text-align:center;margin:0;padding:16px">
                <div><strong>üì± Paytm</strong></div>
                <div class="small">Min: 5000 coins (‚Çπ500)</div>
                <button class="btn withdraw-btn" data-method="Paytm" data-min="5000" style="margin-top:8px">Withdraw</button>
              </div>
            </div>
            
            <div style="margin-top:12px">
              <div class="card" style="text-align:center;margin:0;padding:16px">
                <div><strong>üè¶ Bank Transfer</strong></div>
                <div class="small">Min: 10000 coins (‚Çπ1000)</div>
                <button class="btn withdraw-btn" data-method="Bank" data-min="10000" style="margin-top:8px">Withdraw</button>
              </div>
            </div>
          </div>

          <div style="margin-top:20px">
            <h4 style="margin:0 0 12px 0">üìã Withdrawal History</h4>
            <div id="withdraw-history" class="list">
              <div class="small">No withdrawal requests yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Tab Panel -->
      <div id="profile" class="tab-panel" style="display:none">
        <div class="card profile-row">
          <div class="avatar" id="avatar">U</div>
          <div style="flex:1">
            <h3 id="profile-name" style="margin:0">User</h3>
            <div id="profile-email" class="small">email@example.com</div>
            <div style="margin-top:12px">
              <button id="logout" class="btn ghost">üö™ Logout</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 12px 0">üìä Account Summary</h4>
          <div class="stats-grid">
            <div class="card" style="text-align:center;margin:0;padding:12px">
              <div class="stat-value" id="profile-coins">0</div>
              <div class="stat-label">üí∞ Total Coins</div>
            </div>
            <div class="card" style="text-align:center;margin:0;padding:12px">
              <div class="stat-value" id="profile-withdraw-count">0</div>
              <div class="stat-label">üí∏ Withdrawals</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 12px 0">üìà Recent Activity</h4>
          <div id="recent-activity" class="list">
            <div class="small">No recent activity yet.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="small" style="text-align:center;margin-top:16px;color:rgba(255,255,255,0.7)">
      Made with ‚ù§Ô∏è ‚Äî Premium rewards platform
    </div>
  </div>

  <!-- Offerwall Modal -->
  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <strong>üéØ Offerwall</strong>
        <div>
          <button id="open-in-new" class="close-btn">üîó Open in new tab</button>
          <button id="close-modal" class="close-btn">‚ùå Close</button>
        </div>
      </div>
      <div class="modal-body" id="modal-body">
        <iframe id="offer-iframe" src="" frameborder="0" title="Offerwall"></iframe>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
    <div class="tab active" data-tab="tasks">
      üéØ<br><span style="font-size:10px">Tasks</span>
    </div>
    <div class="tab" data-tab="referral">
      ü§ù<br><span style="font-size:10px">Referral</span>
    </div>
    <div class="tab" data-tab="withdraw">
      üí∏<br><span style="font-size:10px">Withdraw</span>
    </div>
    <div class="tab" data-tab="profile">
      üë§<br><span style="font-size:10px">Profile</span>
    </div>
  </nav>

  <!-- Toast Notification -->
  <div id="toast"></div>

  <script>
    /* ===== FIREBASE CONFIG =====*/
    const firebaseConfig = {
      apiKey: "AIzaSyBNT7CLJ6QCcsFD_lhcrru3UOEqLmiYc3E",
      authDomain: "mreward-5e36d.firebaseapp.com",
      projectId: "mreward-5e36d",
      storageBucket: "mreward-5e36d.firebasestorage.app",
      messagingSenderId: "207849836641",
      appId: "1:207849836641:web:3229c8d3805338fdf49a20"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* ===== UI REFERENCES ===== */
    const tabs = document.querySelectorAll('.tab');
    const panels = {
      tasks: document.getElementById('tasks'),
      referral: document.getElementById('referral'),
      withdraw: document.getElementById('withdraw'),
      profile: document.getElementById('profile')
    };
    const authPanel = document.getElementById('auth-panel');
    const userArea = document.getElementById('user-area');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const signinBtn = document.getElementById('signin-btn');
    const signupBtn = document.getElementById('signup-btn');
    const authMsg = document.getElementById('auth-msg');

    const coinBalanceEl = document.getElementById('coin-balance');
    const refCodeEl = document.getElementById('ref-code');
    const avatarEl = document.getElementById('avatar');
    const profileNameEl = document.getElementById('profile-name');
    const profileEmailEl = document.getElementById('profile-email');
    const profileCoinsEl = document.getElementById('profile-coins');
    const withdrawHistoryEl = document.getElementById('withdraw-history');
    const profileWithdrawCount = document.getElementById('profile-withdraw-count');
    const recentActivityEl = document.getElementById('recent-activity');
    const dailyMsgEl = document.getElementById('daily-msg');
    const dailyStatusEl = document.getElementById('daily-status');

    const openOfferwallBtn = document.getElementById('open-offerwall');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const offerIframe = document.getElementById('offer-iframe');
    const closeModal = document.getElementById('close-modal');
    const openInNew = document.getElementById('open-in-new');
    const toast = document.getElementById('toast');

    /* ===== UTILITY FUNCTIONS ===== */
    function showToast(msg, ms = 3000) {
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', ms);
    }

    function showAuth(show) {
      authPanel.style.display = show ? 'block' : 'none';
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    /* ===== ENHANCED TAB SWITCHING ===== */
    function switchToTab(tabName) {
      // Remove active class from all tabs
      tabs.forEach(tab => tab.classList.remove('active'));
      
      // Add active class to clicked tab
      const clickedTab = document.querySelector(`[data-tab="${tabName}"]`);
      if (clickedTab) {
        clickedTab.classList.add('active');
      }
      
      // Hide all panels
      Object.values(panels).forEach(panel => {
        if (panel) panel.style.display = 'none';
      });
      
      // Show selected panel
      if (panels[tabName]) {
        panels[tabName].style.display = 'block';
      }
      
      // Show auth panel for profile if not signed in
      if (tabName === 'profile' && !auth.currentUser) {
        showAuth(true);
      } else if (auth.currentUser) {
        showAuth(false);
      }
    }

    // Attach tab event listeners
    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const tabName = tab.dataset.tab;
        if (tabName) {
          switchToTab(tabName);
        }
      });
    });

    /* ===== AUTHENTICATION ===== */
    auth.onAuthStateChanged(async user => {
      try {
        if (user) {
          showAuth(false);
          userArea.innerHTML = `<div class="small" style="color: rgba(255,255,255,0.9)">Hi, ${escapeHtml(user.email?.split('@')[0] || 'User')} üëã</div>`;
          
          const userRef = db.collection('users').doc(user.uid);
          await userRef.set({
            email: user.email,
            displayName: user.displayName || null,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          // Real-time user data listener
          userRef.onSnapshot(doc => {
            const data = doc.data() || {};
            const coins = data.coins || 0;
            
            // Update coin displays
            coinBalanceEl.textContent = coins.toLocaleString();
            profileCoinsEl.textContent = coins.toLocaleString();
            
            // Update referral code
            const refCode = data.referral_code || generateAndSaveReferral(user.uid);
            refCodeEl.textContent = refCode;
            
            // Update profile info
            const displayName = data.displayName || user.email?.split('@')[0] || 'User';
            avatarEl.textContent = displayName[0].toUpperCase();
            profileNameEl.textContent = displayName;
            profileEmailEl.textContent = user.email;
            
            // Update daily status
            const today = new Date().toISOString().slice(0, 10);
            const lastClaim = data.lastClaim;
            if (lastClaim === today) {
              dailyStatusEl.textContent = '‚úÖ';
            } else {
              dailyStatusEl.textContent = 'üéÅ';
            }
          });

          loadWithdrawHistory(user.uid);
          loadRecentActivity(user.uid);
        } else {
          // User signed out
          showAuth(true);
          userArea.innerHTML = '';
          coinBalanceEl.textContent = '0';
          refCodeEl.textContent = 'LOADING';
          avatarEl.textContent = 'U';
          profileNameEl.textContent = 'User';
          profileEmailEl.textContent = 'email@example.com';
          dailyStatusEl.textContent = 'üéÅ';
        }
      } catch (error) {
        console.error('Auth state change error:', error);
        showToast('Authentication error occurred');
      }
    });

    /* ===== SIGN UP ===== */
    signupBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const pass = passInput.value;
      authMsg.textContent = '';
      
      if (!email || pass.length < 6) {
        authMsg.textContent = 'Enter valid email & password (min 6 chars)';
        return;
      }
      
      try {
        authMsg.textContent = 'Creating account...';
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        const user = cred.user;
        
        await db.collection('users').doc(user.uid).set({
          email: user.email,
          coins: 500, // Welcome bonus
          referral_code: generateReferralCode(6),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Log welcome activity
        await db.collection('user_activity').add({
          userId: user.uid,
          title: 'Welcome Bonus',
          notes: '+500 coins for joining!',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        authMsg.textContent = 'Account created successfully! üéâ';
        showToast('Welcome! You received 500 bonus coins! üéâ');
        
        // Clear form
        emailInput.value = '';
        passInput.value = '';
        
      } catch (error) {
        console.error('Signup error:', error);
        authMsg.textContent = error.message;
      }
    });

    /* ===== SIGN IN ===== */
    signinBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const pass = passInput.value;
      authMsg.textContent = '';
      
      if (!email || pass.length < 6) {
        authMsg.textContent = 'Enter valid email & password (min 6 chars)';
        return;
      }
      
      try {
        authMsg.textContent = 'Signing in...';
        await auth.signInWithEmailAndPassword(email, pass);
        authMsg.textContent = 'Signed in successfully! üéâ';
        showToast('Welcome back! üëã');
        
        // Clear form
        emailInput.value = '';
        passInput.value = '';
        
      } catch (error) {
        console.error('Signin error:', error);
        authMsg.textContent = error.message;
      }
    });

    /* ===== LOGOUT ===== */
    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await auth.signOut();
        showToast('Signed out successfully');
        switchToTab('tasks'); // Switch to tasks after logout
      } catch (error) {
        console.error('Logout error:', error);
        showToast('Error signing out');
      }
    });

    /* ===== REFERRAL FUNCTIONS ===== */
    function generateReferralCode(length = 6) {
      const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < length; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    async function generateAndSaveReferral(uid) {
      try {
        const userRef = db.collection('users').doc(uid);
        const doc = await userRef.get();
        const data = doc.data() || {};
        
        if (data.referral_code) return data.referral_code;
        
        const newCode = generateReferralCode(6);
        await userRef.set({ referral_code: newCode }, { merge: true });
        return newCode;
      } catch (error) {
        console.error('Error generating referral code:', error);
        return 'ERROR';
      }
    }

    /* ===== COPY REFERRAL CODE ===== */
    document.getElementById('copy-ref').addEventListener('click', async () => {
      const refCode = refCodeEl.textContent;
      if (refCode === 'LOADING' || refCode === 'ERROR') return;
      
      try {
        const referralUrl = `${window.location.origin}${window.location.pathname}?ref=${refCode}`;
        await navigator.clipboard.writeText(referralUrl);
        showToast('Referral link copied! üìã');
      } catch (error) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = `${window.location.origin}${window.location.pathname}?ref=${refCode}`;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Referral link copied! üìã');
      }
    });

    /* ===== SOCIAL SHARING ===== */
    document.getElementById('share-wa').addEventListener('click', () => {
      const refCode = refCodeEl.textContent;
      if (refCode === 'LOADING' || refCode === 'ERROR') return;
      
      const message = `üéâ Join Mreward PRO and earn coins instantly! Use my referral code: ${refCode} 
üí∞ Get 50 bonus coins when you sign up!
üîó ${window.location.origin}${window.location.pathname}?ref=${refCode}`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    });

    document.getElementById('share-tg').addEventListener('click', () => {
      const refCode = refCodeEl.textContent;
      if (refCode === 'LOADING' || refCode === 'ERROR') return;
      
      const message = `üéâ Join Mreward PRO and earn coins instantly! Use my referral code: ${refCode} 
üí∞ Get 50 bonus coins when you sign up!
üîó ${window.location.origin}${window.location.pathname}?ref=${refCode}`;
      const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.origin + window.location.pathname + '?ref=' + refCode)}&text=${encodeURIComponent(message)}`;
      window.open(telegramUrl, '_blank');
    });

    /* ===== OFFERWALL SETTINGS ===== */
    let cpagripUrl = '';

    async function loadSettings() {
      try {
        const settingsDoc = await db.collection('app_settings').doc('settings').get();
        const data = settingsDoc.exists ? settingsDoc.data() : null;
        if (data && data.cpagrip_url) {
          cpagripUrl = data.cpagrip_url;
        }
      } catch (error) {
        console.warn('Settings load error:', error);
      }
    }

    // Load settings on app start
    loadSettings();

    function isCpagripUrl(url) {
      try {
        if (!url) return false;
        const u = new URL(url.indexOf('http') === 0 ? url : ('https://' + url));
        return u.hostname.includes('cpagrip') || url.includes('cpagrip');
      } catch (error) {
        return url && url.includes('cpagrip');
      }
    }

    /* ===== OFFERWALL MODAL - ENHANCED ===== */
    function openOfferUrl(url) {
      if (!url) {
        showToast('No offer URL configured');
        return;
      }
      
      // Normalize URL
      if (!/^https?:\/\//i.test(url)) {
        url = 'https://' + url;
      }
      
      if (isCpagripUrl(url)) {
        // For CPAGrip, always open in new tab (no overlay)
        window.open(url, '_blank');
        showToast('Offerwall opened in new tab');
      } else {
        // For other URLs, use modal
        offerIframe.src = url;
        modalBackdrop.style.display = 'flex';
      }
    }

    openOfferwallBtn.addEventListener('click', () => {
      const user = auth.currentUser;
      if (!user) {
        showToast('Please sign in first');
        switchToTab('profile');
        return;
      }
      
      const url = cpagripUrl || '';
      if (!url) {
        showToast('Offerwall not configured by admin');
        return;
      }
      
      openOfferUrl(url);
    });

    closeModal.addEventListener('click', () => {
      offerIframe.src = ''; // Stop loading offer content
      modalBackdrop.style.display = 'none';
    });

    openInNew.addEventListener('click', () => {
      const url = offerIframe.src || cpagripUrl || '';
      if (url) {
        window.open(url, '_blank');
        modalBackdrop.style.display = 'none';
      }
    });

    // Close modal on backdrop click
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) {
        closeModal.click();
      }
    });

    /* ===== DAILY REWARD - ENHANCED ===== */
    document.getElementById('claim-daily').addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        dailyMsgEl.textContent = 'Please sign in first';
        showToast('Please sign in to claim daily reward');
        return;
      }
      
      const userRef = db.collection('users').doc(user.uid);
      const today = new Date().toISOString().slice(0, 10);
      
      try {
        dailyMsgEl.textContent = 'Claiming...';
        
        await db.runTransaction(async (transaction) => {
          const userDoc = await transaction.get(userRef);
          const userData = userDoc.data() || {};
          
          if (userData.lastClaim === today) {
            throw new Error('Already claimed today! Come back tomorrow üåÖ');
          }
          
          const currentCoins = userData.coins || 0;
          const bonusCoins = 50;
          const newCoins = currentCoins + bonusCoins;
          
          transaction.update(userRef, {
            coins: newCoins,
            lastClaim: today
          });
          
          // Log activity
          const activityRef = db.collection('user_activity').doc();
          transaction.set(activityRef, {
            userId: user.uid,
            title: 'Daily Reward Claimed',
            notes: `+${bonusCoins} coins`,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        
        dailyMsgEl.textContent = 'Daily reward claimed! +50 coins üéâ';
        showToast('üéÅ Daily reward claimed! +50 coins');
        
      } catch (error) {
        console.error('Daily claim error:', error);
        dailyMsgEl.textContent = error.message || 'Error claiming reward';
      }
    });

    /* ===== WITHDRAWAL SYSTEM - ENHANCED ===== */
    document.querySelectorAll('.withdraw-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const method = btn.dataset.method;
        const minCoins = parseInt(btn.dataset.min, 10);
        const user = auth.currentUser;
        
        if (!user) {
          alert('Please sign in first');
          switchToTab('profile');
          return;
        }
        
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          const userData = userDoc.data() || {};
          const currentCoins = userData.coins || 0;
          
          if (currentCoins < minCoins) {
            alert(`Insufficient coins! You need at least ${minCoins} coins for ${method} withdrawal.`);
            return;
          }
          
          const amount = prompt(`Enter amount to withdraw in coins (min ${minCoins}, max ${currentCoins}):`);
          if (!amount) return;
          
          const coinsToWithdraw = parseInt(amount, 10);
          if (isNaN(coinsToWithdraw) || coinsToWithdraw < minCoins || coinsToWithdraw > currentCoins) {
            alert('Invalid amount entered');
            return;
          }
          
          const destination = prompt(`Enter ${method} details:\n${method === 'UPI' ? 'UPI ID' : method === 'Paytm' ? 'Mobile Number' : 'Bank Account Details'}`);
          if (!destination) return;
          
          // Create withdrawal request
          await db.collection('withdraw_requests').add({
            userId: user.uid,
            email: user.email,
            method: method,
            destination: destination,
            coins: coinsToWithdraw,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Deduct coins immediately
          await db.collection('users').doc(user.uid).update({
            coins: currentCoins - coinsToWithdraw
          });
          
          // Log activity
          await db.collection('user_activity').add({
            userId: user.uid,
            title: 'Withdrawal Requested',
            notes: `${method} withdrawal of ${coinsToWithdraw} coins`,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          showToast(`Withdrawal request submitted! Processing ${coinsToWithdraw} coins via ${method}`);
          
        } catch (error) {
          console.error('Withdrawal error:', error);
          showToast('Error processing withdrawal request');
        }
      });
    });

    /* ===== WITHDRAWAL HISTORY ===== */
    async function loadWithdrawHistory(uid) {
      try {
        withdrawHistoryEl.innerHTML = '<div class="small">Loading withdrawal history...</div>';
        
        const query = db.collection('withdraw_requests')
          .where('userId', '==', uid)
          .orderBy('createdAt', 'desc')
          .limit(10);
          
        query.onSnapshot(snapshot => {
          withdrawHistoryEl.innerHTML = '';
          
          if (snapshot.empty) {
            withdrawHistoryEl.innerHTML = '<div class="small">No withdrawal requests yet.</div>';
            profileWithdrawCount.textContent = '0';
            return;
          }
          
          let count = 0;
          snapshot.forEach(doc => {
            count++;
            const data = doc.data();
            const createdAt = data.createdAt?.toDate() || new Date();
            const statusColor = data.status === 'approved' ? '#10b981' : 
                              data.status === 'rejected' ? '#ef4444' : '#f59e0b';
            
            const element = document.createElement('div');
            element.className = 'list-item';
            element.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center">
                <div>
                  <strong>${escapeHtml(data.method)} - ${data.coins} coins</strong>
                  <div class="small">${createdAt.toLocaleDateString()}</div>
                </div>
                <div style="color: ${statusColor}; font-weight: 600; text-transform: uppercase; font-size: 12px">
                  ${data.status}
                </div>
              </div>
            `;
            withdrawHistoryEl.appendChild(element);
          });
          
          profileWithdrawCount.textContent = count.toString();
        });
        
      } catch (error) {
        console.error('Error loading withdrawal history:', error);
        withdrawHistoryEl.innerHTML = '<div class="small">Error loading history.</div>';
      }
    }

    /* ===== RECENT ACTIVITY ===== */
    function loadRecentActivity(uid) {
      try {
        const query = db.collection('user_activity')
          .where('userId', '==', uid)
          .orderBy('createdAt', 'desc')
          .limit(10);
          
        query.onSnapshot(snapshot => {
          recentActivityEl.innerHTML = '';
          
          if (snapshot.empty) {
            recentActivityEl.innerHTML = '<div class="small">No recent activity yet.</div>';
            return;
          }
          
          snapshot.forEach(doc => {
            const data = doc.data();
            const element = document.createElement('div');
            element.className = 'list-item';
            element.innerHTML = `
              <div>
                <strong>${escapeHtml(data.title || '')}</strong>
                <div class="small">${escapeHtml(data.notes || '')}</div>
              </div>
            `;
            recentActivityEl.appendChild(element);
          });
        });
        
      } catch (error) {
        console.error('Error loading recent activity:', error);
        recentActivityEl.innerHTML = '<div class="small">Error loading activity.</div>';
      }
    }

    /* ===== DYNAMIC TASKS SYSTEM ===== */
    function renderTasks(taskDocs) {
      const tasksList = document.getElementById('tasks-list');
      tasksList.innerHTML = '';
      
      if (!taskDocs || taskDocs.length === 0) {
        tasksList.innerHTML = '<div class="small">No tasks available at the moment. Check back later! üìÖ</div>';
        return;
      }
      
      taskDocs.forEach(doc => {
        const data = doc.data();
        const element = document.createElement('div');
        element.className = 'list-item';
        
        const offerButton = data.offer_url ? 
          `<button class="btn ghost open-offer" data-url="${escapeHtml(data.offer_url)}" style="margin-right: 8px">
             üìã Start Task
           </button>` : '';
        
        element.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px">
            <div style="flex: 1">
              <strong>${escapeHtml(data.title || 'Untitled Task')}</strong>
              <div class="small">${escapeHtml(data.desc || 'No description available')}</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end">
              <div style="color: var(--success); font-weight: 700">+${(data.coins || 0)} coins</div>
              <div style="display: flex; gap: 8px">
                ${offerButton}
                <button class="btn success claim-task" data-id="${doc.id}" data-coins="${(data.coins || 0)}">
                  üéÅ Claim +${(data.coins || 0)}
                </button>
              </div>
            </div>
          </div>
        `;
        
        tasksList.appendChild(element);
      });
      
      // Attach event listeners for offer buttons
      document.querySelectorAll('.open-offer').forEach(button => {
        button.addEventListener('click', (event) => {
          const user = auth.currentUser;
          if (!user) {
            showToast('Please sign in first');
            switchToTab('profile');
            return;
          }
          
          const url = event.target.dataset.url;
          if (url) {
            openOfferUrl(url);
          }
        });
      });
      
      // Attach event listeners for claim buttons
      document.querySelectorAll('.claim-task').forEach(button => {
        button.addEventListener('click', async (event) => {
          const user = auth.currentUser;
          if (!user) {
            alert('Please sign in first');
            switchToTab('profile');
            return;
          }
          
          const taskId = event.target.dataset.id;
          const coins = parseInt(event.target.dataset.coins, 10) || 0;
          
          if (coins <= 0) {
            showToast('Invalid task reward');
            return;
          }
          
          try {
            event.target.disabled = true;
            event.target.textContent = 'Claiming...';
            
            const userRef = db.collection('users').doc(user.uid);
            
            await db.runTransaction(async (transaction) => {
              const userDoc = await transaction.get(userRef);
              const userData = userDoc.data() || {};
              const currentCoins = userData.coins || 0;
              const newCoins = currentCoins + coins;
              
              transaction.update(userRef, { coins: newCoins });
              
              // Log the task completion activity
              const activityRef = db.collection('user_activity').doc();
              transaction.set(activityRef, {
                userId: user.uid,
                title: 'Task Completed',
                notes: `+${coins} coins earned`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            });
            
            showToast(`üéâ Task completed! +${coins} coins earned`);
            
          } catch (error) {
            console.error('Task claim error:', error);
            showToast('Error claiming task reward');
            event.target.disabled = false;
            event.target.textContent = `üéÅ Claim +${coins}`;
          }
        });
      });
    }

    /* ===== REAL-TIME TASKS LISTENER ===== */
    db.collection('tasks')
      .orderBy('coins', 'desc')
      .onSnapshot(
        snapshot => {
          renderTasks(snapshot.docs);
        },
        error => {
          console.warn('Tasks listener error:', error);
          renderTasks([]);
        }
      );

    /* ===== REFERRAL SYSTEM ===== */
    function handleReferralOnSignup() {
      const urlParams = new URLSearchParams(window.location.search);
      const refCode = urlParams.get('ref');
      if (refCode) {
        localStorage.setItem('pending_referral', refCode);
        showToast(`Using referral code: ${refCode}`);
      }
    }

    // Handle referral bonus when user signs up
    auth.onAuthStateChanged(async user => {
      if (!user) return;
      
      const pendingRef = localStorage.getItem('pending_referral');
      if (pendingRef) {
        try {
          const referrerQuery = await db.collection('users')
            .where('referral_code', '==', pendingRef)
            .limit(1)
            .get();
            
          if (!referrerQuery.empty) {
            const referrerDoc = referrerQuery.docs[0];
            const referrerUid = referrerDoc.id;
            const referrerData = referrerDoc.data();
            
            // Check if user hasn't already been referred
            const currentUserDoc = await db.collection('users').doc(user.uid).get();
            const currentUserData = currentUserDoc.data() || {};
            
            if (!currentUserData.referred_by) {
              const batch = db.batch();
              
              // Give bonus to referrer
              batch.update(db.collection('users').doc(referrerUid), {
                coins: firebase.firestore.FieldValue.increment(100)
              });
              
              // Give bonus to new user and mark as referred
              batch.update(db.collection('users').doc(user.uid), {
                coins: firebase.firestore.FieldValue.increment(50),
                referred_by: pendingRef
              });
              
              await batch.commit();
              
              // Log activities
              await Promise.all([
                db.collection('user_activity').add({
                  userId: referrerUid,
                  title: 'Referral Bonus',
                  notes: `+100 coins for referring ${user.email}`,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }),
                db.collection('user_activity').add({
                  userId: user.uid,
                  title: 'Referral Signup Bonus',
                  notes: '+50 coins for using referral code',
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                })
              ]);
              
              localStorage.removeItem('pending_referral');
              showToast('üéâ Referral bonus applied! +50 coins');
            }
          }
        } catch (error) {
          console.error('Referral processing error:', error);
        }
      }
    });

    /* ===== INITIALIZATION ===== */
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize referral system
      handleReferralOnSignup();
      
      // Set initial tab visibility
      Object.values(panels).forEach(panel => {
        if (panel) panel.style.display = 'none';
      });
      
      if (panels.tasks) {
        panels.tasks.style.display = 'block';
      }
      
      // Initialize auth state
      const user = auth.currentUser;
      if (!user) {
        showAuth(true);
      }
    });

    /* ===== KEYBOARD SHORTCUTS ===== */
    document.addEventListener('keydown', (e) => {
      // ESC to close modal
      if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') {
        closeModal.click();
      }
      
      // Enter to submit auth forms
      if (e.key === 'Enter' && (emailInput === document.activeElement || passInput === document.activeElement)) {
        if (emailInput.value && passInput.value) {
          signinBtn.click();
        }
      }
    });

    /* ===== ERROR HANDLING ===== */
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      showToast('An error occurred. Please refresh the page.');
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
    });

  </script>
</body>
</html>
