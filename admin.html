<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mreward PRO - Admin Dashboard</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      overflow-x: hidden;
    }
    
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px 20px;
      padding-top: 80px;
    }
    
    /* Mobile-First Tabbed Navigation */
    .tab-navigation {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 2px solid rgba(102, 126, 234, 0.1);
      z-index: 1000;
      padding: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    
    .tab-container {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 4px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .tab-container::-webkit-scrollbar {
      display: none;
    }
    
    .tab-button {
      background: transparent;
      border: 2px solid #e1e8ed;
      color: #666;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-width: fit-content;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .tab-button.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .tab-button:hover:not(.active) {
      border-color: #667eea;
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }
    
    /* Section Container */
    .admin-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      display: none;
    }
    
    .admin-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .admin-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    
    .admin-title {
      font-size: 28px;
      font-weight: 700;
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
    }
    
    .admin-subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }
    
    .admin-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #51cf66, #40c057);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    .table th,
    .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e1e8ed;
    }
    
    .table th {
      background: #f8fafc;
      font-weight: 600;
      color: #333;
    }
    
    .table tr:hover {
      background: #f8fafc;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-approved {
      background: #d4edda;
      color: #155724;
    }
    
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    .toast.success { background: #51cf66; }
    .toast.error { background: #ff6b6b; }
    .toast.info { background: #667eea; }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* Mobile-First Responsive Design */
    @media (max-width: 768px) {
      .admin-container {
        padding: 0 12px 20px;
        padding-top: 80px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      .admin-section {
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }
      
      .tab-button {
        padding: 8px 12px;
        font-size: 12px;
        min-width: 100px;
      }
      
      /* Mobile Table Styles */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .table {
        font-size: 12px;
        min-width: 600px;
      }
      
      .table th,
      .table td {
        padding: 8px;
        white-space: nowrap;
      }
      
      /* Card-based view for mobile */
      .mobile-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
      }
      
      .mobile-card-header {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 8px;
        font-size: 14px;
      }
      
      .mobile-card-content {
        font-size: 13px;
        line-height: 1.4;
        color: #666;
      }
      
      .mobile-card-actions {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .mobile-card-actions .btn {
        padding: 6px 12px;
        font-size: 11px;
        flex: 1;
        min-width: 80px;
      }
      
      /* Form improvements for mobile */
      .form-input, .btn {
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .btn {
        padding: 12px 20px;
        touch-action: manipulation;
      }
      
      /* Two-column form layout for mobile */
      .form-grid {
        display: grid;
        gap: 16px;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
    }
    
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .tab-button {
        padding: 6px 10px;
        font-size: 11px;
        min-width: 80px;
      }
      
      .admin-section {
        padding: 12px;
      }
      
      .mobile-card {
        padding: 12px;
      }
    }
    
    /* Tablet Styles */
    @media (min-width: 769px) and (max-width: 1024px) {
      .tab-container {
        justify-content: center;
        flex-wrap: wrap;
        overflow-x: visible;
      }
      
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* Desktop Styles */
    @media (min-width: 1025px) {
      .tab-container {
        justify-content: center;
        flex-wrap: wrap;
        overflow-x: visible;
      }
      
      .admin-container {
        padding: 0 20px 20px;
        padding-top: 100px;
      }
      
      .tab-navigation {
        padding: 12px 20px;
      }
      
      .tab-button {
        padding: 12px 24px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <!-- Mobile-First Tabbed Navigation -->
  <nav class="tab-navigation">
    <div class="tab-container">
      <button class="tab-button" onclick="showSection('dashboard')">
        📊 Dashboard
      </button>
      <button class="tab-button active" onclick="showSection('withdrawals')">
        💸 Withdrawals
      </button>
      <button class="tab-button" onclick="showSection('users')">
        👥 Users
      </button>
      <button class="tab-button" onclick="showSection('tasks')">
        🎯 Tasks
      </button>
      <button class="tab-button" onclick="showSection('activities')">
        📋 Activities
      </button>
      <button class="tab-button" onclick="showSection('settings')">
        ⚙️ Settings
      </button>
    </div>
  </nav>

  <div class="admin-container">
    <!-- Dashboard Section -->
    <div id="dashboard-section" class="admin-section">
      <!-- Header with Stats -->
      <div class="admin-header">
        <h1 class="admin-title">🎯 Mreward PRO Admin Dashboard</h1>
        <p class="admin-subtitle">Complete control over your rewards platform</p>
        
        <!-- Real-time Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="total-users">0</div>
            <div class="stat-label">👥 Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-coins">0</div>
            <div class="stat-label">💰 Total Coins</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-tasks">0</div>
            <div class="stat-label">🎯 Active Tasks</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="pending-withdrawals">0</div>
            <div class="stat-label">💸 Pending Withdrawals</div>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn btn-success" onclick="loadStats()">🔄 Refresh Stats</button>
          <button class="btn" onclick="exportUsers()">📊 Export Users</button>
          <button class="btn btn-danger" onclick="clearOldTasks()">🧹 Clear Old Tasks</button>
        </div>
      </div>
    </div>

    <!-- Withdrawals Section (Default Active - Most Critical) -->
    <div id="withdrawals-section" class="admin-section active">
      <h2 class="section-title">💸 Withdrawal Management</h2>
      
      <!-- Withdrawal Statistics -->
      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-card">
          <div class="stat-value" id="pending-count">0</div>
          <div class="stat-label">⏳ Pending</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="approved-count">0</div>
          <div class="stat-label">✅ Approved</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="rejected-count">0</div>
          <div class="stat-label">❌ Rejected</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-amount">0</div>
          <div class="stat-label">💰 Total Amount</div>
        </div>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>User</th>
              <th>Method</th>
              <th>Amount</th>
              <th>Destination</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="withdrawals-tbody">
            <tr>
              <td colspan="7" style="text-align: center;">Loading withdrawal requests...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users Section -->
    <div id="users-section" class="admin-section">
      <h2 class="section-title">👥 User Management</h2>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Coins</th>
              <th>Tasks Completed</th>
              <th>Total Earned</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr>
              <td colspan="6" style="text-align: center;">Loading users...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tasks Section -->
    <div id="tasks-section" class="admin-section">
      <h2 class="section-title">🎯 Task Management</h2>
      
      <!-- Add New Task Form -->
      <div class="form-grid" style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px;">
        <div>
          <h3 style="margin-bottom: 16px;">➕ Add New Task</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
            <div class="form-group">
              <label class="form-label">Task Type</label>
              <select id="task-type" class="form-input" onchange="handleTaskTypeChange()">
                <option value="simple">Simple Task (No Link)</option>
                <option value="external">External Link Task</option>
                <option value="youtube">YouTube Video Task</option>
                <option value="survey">Survey Task</option>
                <option value="social">Social Media Task</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Reward (Coins)</label>
              <input type="number" id="task-coins" class="form-input" placeholder="25" min="1" max="1000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Task Title</label>
            <input type="text" id="task-title" class="form-input" placeholder="e.g. Watch YouTube Video">
          </div>
          <div class="form-group">
            <label class="form-label">Task Description</label>
            <input type="text" id="task-desc" class="form-input" placeholder="e.g. Watch a 2-minute video and subscribe">
          </div>
          <div class="form-group" id="task-link-group" style="display: none;">
            <label class="form-label">Task Link/URL</label>
            <input type="url" id="task-link" class="form-input" placeholder="https://youtube.com/watch?v=...">
            <small style="color: #666; font-size: 12px;">Users will be redirected to this link to complete the task</small>
          </div>
          <div class="form-group">
            <label class="form-label">Task Instructions</label>
            <textarea id="task-instructions" class="form-input" rows="3" placeholder="Step by step instructions for users..."></textarea>
          </div>
          <button class="btn" onclick="addTask()" style="width: 100%;">🎯 Add Task</button>
        </div>
      </div>
      
      <!-- Active Tasks List -->
      <h3>📋 Active Tasks</h3>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Title</th>
              <th>Description</th>
              <th>Link</th>
              <th>Reward</th>
              <th>Completed</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tasks-tbody">
            <tr>
              <td colspan="8" style="text-align: center;">Loading tasks...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Activities Section -->
    <div id="activities-section" class="admin-section">
      <h2 class="section-title">📊 Task Activities Monitor</h2>
      
      <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn" onclick="loadTaskActivities()">🔄 Refresh Activities</button>
        <button class="btn" onclick="exportActivities()">📄 Export Activities</button>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>User</th>
              <th>Task ID</th>
              <th>Action</th>
              <th>Coins Earned</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="activities-tbody">
            <tr>
              <td colspan="5" style="text-align: center;">Loading activities...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Settings Section -->
    <div id="settings-section" class="admin-section">
      <h2 class="section-title">⚙️ System Settings</h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div>
          <h3 style="margin-bottom: 16px;">💰 Reward Settings</h3>
          <div class="form-group">
            <label class="form-label">Daily Reward Amount</label>
            <input type="number" id="daily-reward" class="form-input" value="50" min="1" max="500">
          </div>
          <div class="form-group">
            <label class="form-label">Referral Bonus</label>
            <input type="number" id="referral-bonus" class="form-input" value="100" min="1" max="1000">
          </div>
          <button class="btn" onclick="updateSettings()" style="width: 100%;">💾 Save Settings</button>
        </div>
        
        <div>
          <h3 style="margin-bottom: 16px;">🔧 Platform Actions</h3>
          <button class="btn" onclick="sendNotificationToAll()" style="margin-bottom: 12px; width: 100%;">📢 Send Global Notification</button>
          <button class="btn btn-success" onclick="giveCoinsToAll()" style="margin-bottom: 12px; width: 100%;">🎁 Give Bonus to All Users</button>
          <button class="btn btn-danger" onclick="resetDatabase()" style="margin-bottom: 12px; width: 100%;">⚠️ Reset Database</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Firebase Configuration with enhanced error handling
    const firebaseConfig = {
      apiKey: "AIzaSyBNT7CLJ6QCcsFD_lhcrru3UOEqLmiYc3E",
      authDomain: "mreward-5e36d.firebaseapp.com",
      projectId: "mreward-5e36d",
      storageBucket: "mreward-5e36d.firebasestorage.app",
      messagingSenderId: "207849836641",
      appId: "1:207849836641:web:3229c8d3805338fdf49a20"
    };

    // Initialize Firebase with error handling
    try {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      console.log('✅ Firebase initialized successfully for admin panel');
      
      // Test database connection
      db.enableNetwork().then(() => {
        console.log('✅ Firestore network enabled');
      }).catch(error => {
        console.error('⚠️ Firestore network error:', error);
      });
      
    } catch (error) {
      console.error('❌ Firebase initialization error:', error);
      alert('Firebase connection failed: ' + error.message);
    }

    // Tab Navigation Function
    function showSection(sectionId) {
      // Hide all sections
      const sections = document.querySelectorAll('.admin-section');
      sections.forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all tabs
      const tabs = document.querySelectorAll('.tab-button');
      tabs.forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected section
      const targetSection = document.getElementById(sectionId + '-section');
      if (targetSection) {
        targetSection.classList.add('active');
      }
      
      // Add active class to clicked tab
      event.target.classList.add('active');
      
      // Load section-specific data
      switch(sectionId) {
        case 'dashboard':
          loadStats();
          break;
        case 'withdrawals':
          loadWithdrawals();
          loadWithdrawalStats();
          break;
        case 'users':
          loadUsers();
          break;
        case 'tasks':
          loadTasks();
          break;
        case 'activities':
          loadTaskActivities();
          break;
        case 'settings':
          loadSystemSettings(); // Load actual settings from Firebase
          break;
      }
    }

    // Enhanced Withdrawal Statistics
    async function loadWithdrawalStats() {
      try {
        const snapshot = await db.collection('withdraw_requests').get();
        let pending = 0, approved = 0, rejected = 0, totalAmount = 0;
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const amount = data.coins || 0;
          totalAmount += amount;
          
          switch(data.status) {
            case 'pending': pending++; break;
            case 'approved': approved++; break;
            case 'rejected': rejected++; break;
          }
        });
        
        document.getElementById('pending-count').textContent = pending;
        document.getElementById('approved-count').textContent = approved;
        document.getElementById('rejected-count').textContent = rejected;
        document.getElementById('total-amount').textContent = totalAmount.toLocaleString();
      } catch (error) {
        console.error('Error loading withdrawal stats:', error);
      }
    }

    // Utility Functions
    function showToast(message, type = 'success', duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, duration);
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // Handle Task Type Changes
    function handleTaskTypeChange() {
      const taskType = document.getElementById('task-type').value;
      const linkGroup = document.getElementById('task-link-group');
      const titleInput = document.getElementById('task-title');
      const descInput = document.getElementById('task-desc');
      
      if (taskType === 'simple') {
        linkGroup.style.display = 'none';
        titleInput.placeholder = 'e.g. Complete Daily Check-in';
        descInput.placeholder = 'e.g. Simply claim your daily reward';
      } else {
        linkGroup.style.display = 'block';
        
        switch(taskType) {
          case 'youtube':
            titleInput.placeholder = 'e.g. Watch YouTube Video - Tech Review';
            descInput.placeholder = 'e.g. Watch full video and subscribe to channel';
            document.getElementById('task-link').placeholder = 'https://youtube.com/watch?v=...';
            break;
          case 'survey':
            titleInput.placeholder = 'e.g. Complete Product Survey';
            descInput.placeholder = 'e.g. Answer 10 questions about your preferences';
            document.getElementById('task-link').placeholder = 'https://forms.google.com/...';
            break;
          case 'social':
            titleInput.placeholder = 'e.g. Follow Instagram Page';
            descInput.placeholder = 'e.g. Follow our official Instagram account';
            document.getElementById('task-link').placeholder = 'https://instagram.com/...';
            break;
          default:
            titleInput.placeholder = 'e.g. Visit Website';
            descInput.placeholder = 'e.g. Visit partner website and explore';
            document.getElementById('task-link').placeholder = 'https://example.com';
        }
      }
    }

    // Load Statistics with enhanced error handling
    async function loadStats() {
      try {
        showToast('Refreshing statistics...', 'info');

        // Get users count and total coins
        const usersSnapshot = await db.collection('users').get();
        let totalUsers = 0;
        let totalCoins = 0;

        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          totalUsers++;
          totalCoins += userData.coins || 0;
        });

        // Get active tasks count
        const tasksSnapshot = await db.collection('tasks').where('active', '==', true).get();
        const totalTasks = tasksSnapshot.size;

        // Get pending withdrawals
        const withdrawalsSnapshot = await db.collection('withdraw_requests').where('status', '==', 'pending').get();
        const pendingWithdrawals = withdrawalsSnapshot.size;

        // Update UI
        document.getElementById('total-users').textContent = totalUsers;
        document.getElementById('total-coins').textContent = totalCoins.toLocaleString();
        document.getElementById('total-tasks').textContent = totalTasks;
        document.getElementById('pending-withdrawals').textContent = pendingWithdrawals;

        showToast('Statistics updated successfully!', 'success');
      } catch (error) {
        console.error('Error loading stats:', error);
        showToast('Error loading statistics', 'error');
      }
    }

    // Add New Task with enhanced features and debugging
    async function addTask() {
      console.log('📋 Starting addTask function...');
      
      const taskType = document.getElementById('task-type').value;
      const title = document.getElementById('task-title').value.trim();
      const desc = document.getElementById('task-desc').value.trim();
      const link = document.getElementById('task-link').value.trim();
      const coins = parseInt(document.getElementById('task-coins').value);
      const instructions = document.getElementById('task-instructions').value.trim();

      console.log('📝 Form data:', { taskType, title, desc, link, coins, instructions });

      // Validation
      if (!title || !desc || !coins || coins < 1) {
        console.error('❌ Validation failed: Missing required fields');
        showToast('Please fill all required fields with valid data', 'error');
        return;
      }

      if (taskType !== 'simple' && !link) {
        console.error('❌ Validation failed: Missing link for external task');
        showToast('Please provide a valid task link/URL', 'error');
        return;
      }

      try {
        console.log('📡 Attempting to add task to database...');
        showToast('Adding new task...', 'info');

        const taskData = {
          title: title,
          desc: desc,
          coins: coins,
          type: taskType,
          active: true,
          instructions: instructions || 'Complete this task to earn coins',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: 'admin',
          completedCount: 0
        };

        // Add link if not simple task
        if (taskType !== 'simple') {
          taskData.link = link;
          console.log('🔗 Added link to task data:', link);
        }

        console.log('💾 Final task data:', taskData);

        // Add task to database
        const docRef = await db.collection('tasks').add(taskData);
        console.log('✅ Task added successfully with ID:', docRef.id);

        // Clear form
        document.getElementById('task-type').value = 'simple';
        document.getElementById('task-title').value = '';
        document.getElementById('task-desc').value = '';
        document.getElementById('task-link').value = '';
        document.getElementById('task-coins').value = '';
        document.getElementById('task-instructions').value = '';
        document.getElementById('task-link-group').style.display = 'none';
        
        console.log('🧹 Form cleared successfully');

        showToast(`✅ ${taskType.toUpperCase()} task "${title}" added successfully!`, 'success');
        
        // Force refresh data
        setTimeout(() => {
          console.log('🔄 Refreshing data...');
          loadTasks();
          loadStats();
        }, 1000);
        
      } catch (error) {
        console.error('❌ Error adding task:', error);
        
        let errorMessage = 'Error adding task: ';
        if (error.code === 'permission-denied') {
          errorMessage = '❌ Permission denied. Please check Firestore security rules.';
        } else if (error.code === 'unavailable') {
          errorMessage = '❌ Database unavailable. Please check your connection.';
        } else {
          errorMessage += error.message;
        }
        
        showToast(errorMessage, 'error');
        
        // Alert for debugging
        alert('Debug Info:\nError Code: ' + (error.code || 'unknown') + '\nError Message: ' + error.message);
      }
    }

    // Load Tasks with enhanced display
    function loadTasks() {
      const tbody = document.getElementById('tasks-tbody');
      
      db.collection('tasks').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        tbody.innerHTML = '';

        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No tasks found. Add your first task above!</td></tr>';
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          
          // Task type badge
          const typeBadge = {
            'simple': '🎯 Simple',
            'external': '🔗 External',
            'youtube': '📺 YouTube', 
            'survey': '📋 Survey',
            'social': '📱 Social'
          };
          
          // Link display
          const linkDisplay = data.link ? 
            `<a href="${data.link}" target="_blank" style="color: #667eea; text-decoration: none;">🔗 Open Link</a>` : 
            'No Link';
          
          row.innerHTML = `
            <td><span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${typeBadge[data.type] || '🎯 Task'}</span></td>
            <td><strong>${data.title || 'N/A'}</strong></td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${data.desc || 'N/A'}</td>
            <td>${linkDisplay}</td>
            <td><span style="color: #51cf66; font-weight: 600;">${data.coins || 0} coins</span></td>
            <td><span style="color: #667eea; font-weight: 600;">${data.completedCount || 0} users</span></td>
            <td>${formatDate(data.createdAt)}</td>
            <td>
              <button class="btn btn-danger" onclick="deleteTask('${doc.id}')" style="padding: 6px 12px; font-size: 12px;">
                🗑️ Delete
              </button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      }, error => {
        console.error('Error loading tasks:', error);
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Error loading tasks. Please refresh.</td></tr>';
      });
    }

    // Delete Task
    async function deleteTask(taskId) {
      if (!confirm('Are you sure you want to delete this task?')) return;

      try {
        await db.collection('tasks').doc(taskId).delete();
        showToast('Task deleted successfully!', 'success');
        loadStats();
      } catch (error) {
        console.error('Error deleting task:', error);
        showToast('Error deleting task', 'error');
      }
    }

    // Load Users
    function loadUsers() {
      const tbody = document.getElementById('users-tbody');
      
      db.collection('users').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        tbody.innerHTML = '';

        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${data.email || 'N/A'}</td>
            <td><span style="color: #667eea; font-weight: 600;">${(data.coins || 0).toLocaleString()}</span></td>
            <td>${data.totalTasks || 0}</td>
            <td><span style="color: #51cf66; font-weight: 600;">${(data.totalEarned || 0).toLocaleString()}</span></td>
            <td>${formatDate(data.createdAt)}</td>
            <td>
              <button class="btn" onclick="giveCoinsToUser('${doc.id}', 100)" style="padding: 6px 12px; font-size: 12px;">
                💰 +100
              </button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      });
    }

    // Give Coins to User
    async function giveCoinsToUser(userId, amount) {
      try {
        const userRef = db.collection('users').doc(userId);
        await userRef.update({
          coins: firebase.firestore.FieldValue.increment(amount),
          totalEarned: firebase.firestore.FieldValue.increment(amount)
        });
        
        showToast(`${amount} coins added to user!`, 'success');
        loadStats();
      } catch (error) {
        console.error('Error giving coins:', error);
        showToast('Error adding coins to user', 'error');
      }
    }

    // Load Withdrawal Requests with Enhanced Controls
    function loadWithdrawals() {
      const tbody = document.getElementById('withdrawals-tbody');
      
      db.collection('withdraw_requests').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        tbody.innerHTML = '';

        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No withdrawal requests</td></tr>';
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          
          // Enhanced status badges
          let statusBadge = '';
          let actionButtons = '';
          
          switch(data.status) {
            case 'approved':
              statusBadge = '<span class="status-badge status-approved">✅ Approved</span>';
              actionButtons = '<span style="color: #666;">Completed</span>';
              break;
            case 'rejected':
              statusBadge = '<span class="status-badge status-rejected">❌ Rejected</span>';
              if (data.rejectionReason) {
                actionButtons = `<small style="color: #666;">Reason: ${data.rejectionReason}</small>`;
              } else {
                actionButtons = '<span style="color: #666;">Rejected</span>';
              }
              break;
            case 'pending':
            default:
              statusBadge = '<span class="status-badge status-pending">⏳ Pending</span>';
              actionButtons = `
                <button class="btn btn-success" onclick="approveWithdrawal('${doc.id}')" style="padding: 6px 12px; font-size: 11px; margin-right: 4px;">
                  ✅ Approve
                </button>
                <button class="btn btn-danger" onclick="rejectWithdrawal('${doc.id}')" style="padding: 6px 12px; font-size: 11px;">
                  ❌ Reject
                </button>
              `;
              break;
          }
          
          row.innerHTML = `
            <td><strong>${data.email || 'N/A'}</strong></td>
            <td>
              <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                ${data.method || 'N/A'}
              </span>
            </td>
            <td><span style="color: #667eea; font-weight: 600; font-size: 16px;">${(data.coins || 0).toLocaleString()}</span></td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${data.destination || 'N/A'}">${data.destination || 'N/A'}</td>
            <td>${statusBadge}</td>
            <td>${formatDate(data.createdAt)}</td>
            <td>${actionButtons}</td>
          `;
          
          tbody.appendChild(row);
        });
        
        // Update stats after loading data
        loadWithdrawalStats();
      }, error => {
        console.error('Error loading withdrawals:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Error loading withdrawal requests. Please refresh.</td></tr>';
      });
    }

    // Enhanced Approve Withdrawal with Confirmation
    async function approveWithdrawal(requestId) {
      try {
        // Get withdrawal details for confirmation
        const doc = await db.collection('withdraw_requests').doc(requestId).get();
        const data = doc.data();
        
        if (!confirm(`Approve withdrawal of ${data.coins} coins to ${data.email}?\n\nMethod: ${data.method}\nDestination: ${data.destination}`)) {
          return;
        }

        await db.collection('withdraw_requests').doc(requestId).update({
          status: 'approved',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
          approvedBy: 'admin'
        });
        
        showToast(`✅ Withdrawal of ${data.coins} coins approved for ${data.email}!`, 'success');
        
        // Optional: Add activity log
        try {
          await db.collection('admin_activities').add({
            action: 'withdrawal_approved',
            withdrawalId: requestId,
            userEmail: data.email,
            amount: data.coins,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            adminId: 'admin'
          });
        } catch (logError) {
          console.log('Activity logging failed:', logError);
        }
        
      } catch (error) {
        console.error('Error approving withdrawal:', error);
        showToast('Error approving withdrawal: ' + error.message, 'error');
      }
    }

    // Enhanced Reject Withdrawal with Reason
    async function rejectWithdrawal(requestId) {
      try {
        // Get withdrawal details
        const doc = await db.collection('withdraw_requests').doc(requestId).get();
        const data = doc.data();
        
        const reason = prompt(`Reject withdrawal of ${data.coins} coins from ${data.email}?\n\nEnter rejection reason (optional):`);
        
        if (reason === null) return; // User cancelled
        
        const updateData = {
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rejectedBy: 'admin'
        };
        
        if (reason.trim()) {
          updateData.rejectionReason = reason.trim();
        }
        
        await db.collection('withdraw_requests').doc(requestId).update(updateData);
        
        // Return coins to user account
        try {
          const userQuery = await db.collection('users').where('email', '==', data.email).get();
          if (!userQuery.empty) {
            const userDoc = userQuery.docs[0];
            await userDoc.ref.update({
              coins: firebase.firestore.FieldValue.increment(data.coins)
            });
          }
        } catch (coinError) {
          console.error('Error returning coins to user:', coinError);
          showToast('Withdrawal rejected but failed to return coins to user account', 'error');
        }
        
        showToast(`❌ Withdrawal rejected${reason ? ' - ' + reason : ''}`, 'success');
        
        // Optional: Add activity log
        try {
          await db.collection('admin_activities').add({
            action: 'withdrawal_rejected',
            withdrawalId: requestId,
            userEmail: data.email,
            amount: data.coins,
            reason: reason || 'No reason provided',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            adminId: 'admin'
          });
        } catch (logError) {
          console.log('Activity logging failed:', logError);
        }
        
      } catch (error) {
        console.error('Error rejecting withdrawal:', error);
        showToast('Error rejecting withdrawal: ' + error.message, 'error');
      }
    }

    // Give Bonus to All Users
    async function giveCoinsToAll() {
      const amount = prompt('Enter amount of coins to give to ALL users:');
      if (!amount || isNaN(amount) || parseInt(amount) < 1) return;
      
      const coinsAmount = parseInt(amount);
      
      if (!confirm(`Are you sure you want to give ${coinsAmount} coins to ALL users?`)) return;
      
      try {
        showToast('Processing bonus for all users...', 'info');
        
        const usersSnapshot = await db.collection('users').get();
        const batch = db.batch();
        
        usersSnapshot.forEach(doc => {
          const userRef = db.collection('users').doc(doc.id);
          batch.update(userRef, {
            coins: firebase.firestore.FieldValue.increment(coinsAmount),
            totalEarned: firebase.firestore.FieldValue.increment(coinsAmount)
          });
        });
        
        await batch.commit();
        
        showToast(`${coinsAmount} coins added to all ${usersSnapshot.size} users!`, 'success');
        loadStats();
      } catch (error) {
        console.error('Error giving coins to all:', error);
        showToast('Error processing bulk bonus', 'error');
      }
    }

    // Export Users Data
    function exportUsers() {
      db.collection('users').get().then(snapshot => {
        let csvContent = "Email,Coins,Total Tasks,Total Earned,Referral Code,Joined\n";
        
        snapshot.forEach(doc => {
          const data = doc.data();
          csvContent += `"${data.email || ''}","${data.coins || 0}","${data.totalTasks || 0}","${data.totalEarned || 0}","${data.referralCode || ''}","${formatDate(data.createdAt)}"\n`;
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'mreward_users_' + new Date().toISOString().slice(0, 10) + '.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        
        showToast('Users data exported successfully!', 'success');
      }).catch(error => {
        console.error('Error exporting users:', error);
        showToast('Error exporting users data', 'error');
      });
    }

    // Clear Old Tasks
    async function clearOldTasks() {
      if (!confirm('Are you sure you want to delete all tasks older than 30 days?')) return;
      
      try {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const oldTasksSnapshot = await db.collection('tasks')
          .where('createdAt', '<', thirtyDaysAgo)
          .get();
        
        if (oldTasksSnapshot.empty) {
          showToast('No old tasks to delete', 'info');
          return;
        }
        
        const batch = db.batch();
        oldTasksSnapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        showToast(`${oldTasksSnapshot.size} old tasks deleted!`, 'success');
        loadStats();
      } catch (error) {
        console.error('Error clearing old tasks:', error);
        showToast('Error clearing old tasks', 'error');
      }
    }

    // Load Task Activities
    function loadTaskActivities() {
      const tbody = document.getElementById('activities-tbody');
      
      db.collection('task_activities')
        .orderBy('timestamp', 'desc')
        .limit(50)
        .onSnapshot(snapshot => {
        tbody.innerHTML = '';

        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No task activities found</td></tr>';
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          
          const actionBadge = data.action === 'completed' ? 
            '<span style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 12px;">✅ Completed</span>' :
            '<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px;">👀 Opened</span>';
          
          row.innerHTML = `
            <td>${data.userEmail || 'Unknown'}</td>
            <td><code style="font-size: 11px;">${doc.data().taskId?.substring(0, 8) || 'N/A'}...</code></td>
            <td>${actionBadge}</td>
            <td>${data.coinsEarned ? `<span style="color: #51cf66; font-weight: 600;">+${data.coinsEarned} coins</span>` : 'N/A'}</td>
            <td>${formatDate(data.timestamp)}</td>
          `;
          
          tbody.appendChild(row);
        });
      }, error => {
        console.error('Error loading task activities:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading activities</td></tr>';
      });
    }

    // Export Activities
    function exportActivities() {
      db.collection('task_activities').orderBy('timestamp', 'desc').get().then(snapshot => {
        let csvContent = "User Email,Task ID,Action,Coins Earned,Timestamp\n";
        
        snapshot.forEach(doc => {
          const data = doc.data();
          csvContent += `"${data.userEmail || ''}","${data.taskId || ''}","${data.action || ''}","${data.coinsEarned || ''}","${formatDate(data.timestamp)}"\n`;
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'mreward_task_activities_' + new Date().toISOString().slice(0, 10) + '.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        
        showToast('Task activities exported successfully!', 'success');
      }).catch(error => {
        console.error('Error exporting activities:', error);
        showToast('Error exporting activities data', 'error');
      });
    }

    // Load System Settings from Firebase
    async function loadSystemSettings() {
      try {
        console.log('🔧 Loading system settings from Firebase...');
        
        // Load settings from Firebase
        const settingsDoc = await db.collection('settings').doc('global').get();
        
        if (settingsDoc.exists) {
          const settings = settingsDoc.data();
          
          // Update settings form with real data
          const dailyRewardInput = document.getElementById('daily-reward');
          const referralBonusInput = document.getElementById('referral-bonus');
          
          if (dailyRewardInput) {
            dailyRewardInput.value = settings.dailyReward || 50;
          }
          
          if (referralBonusInput) {
            referralBonusInput.value = settings.referralBonus || 100;
          }
          
          console.log('✅ Settings loaded:', settings);
          showToast('Settings loaded successfully', 'success');
        } else {
          console.log('⚠️ No settings found, creating default settings...');
          
          // Create default settings
          await db.collection('settings').doc('global').set({
            dailyReward: 50,
            referralBonus: 100,
            minWithdrawal: 2000,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          showToast('Default settings created', 'info');
        }
      } catch (error) {
        console.error('Error loading settings:', error);
        showToast('Error loading settings: ' + error.message, 'error');
      }
    }

    // Initialize Dashboard with all components
    document.addEventListener('DOMContentLoaded', function() {
      showToast('🚀 Admin Dashboard Loaded Successfully!', 'success');
      
      // Load all critical data immediately
      loadStats();
      loadWithdrawals();
      loadWithdrawalStats();
      loadUsers();
      loadTasks();
      loadTaskActivities();
      loadSystemSettings();
      
      console.log('📊 All admin data loading initiated...');
      
      // Auto-refresh stats every 30 seconds
      setInterval(() => {
        // Only refresh if dashboard is active
        const dashboardSection = document.getElementById('dashboard-section');
        if (dashboardSection && dashboardSection.classList.contains('active')) {
          loadStats();
        }
      }, 30000);
      
      // Auto-refresh activities every 60 seconds
      setInterval(() => {
        // Only refresh if activities section is active
        const activitiesSection = document.getElementById('activities-section');
        if (activitiesSection && activitiesSection.classList.contains('active')) {
          loadTaskActivities();
        }
      }, 60000);
      
      // Auto-refresh withdrawals every 15 seconds (most critical)
      setInterval(() => {
        const withdrawalsSection = document.getElementById('withdrawals-section');
        if (withdrawalsSection && withdrawalsSection.classList.contains('active')) {
          loadWithdrawals();
          loadWithdrawalStats();
        }
      }, 15000);
      
      // Set default active section to withdrawals (most critical)
      showSection('withdrawals');
    });

    // Update Settings - Save to Firebase
    async function updateSettings() {
      try {
        console.log('💾 Saving settings to Firebase...');
        
        const dailyReward = parseInt(document.getElementById('daily-reward').value) || 50;
        const referralBonus = parseInt(document.getElementById('referral-bonus').value) || 100;
        
        // Validate inputs
        if (dailyReward < 1 || dailyReward > 500) {
          showToast('Daily reward must be between 1-500 coins', 'error');
          return;
        }
        
        if (referralBonus < 1 || referralBonus > 1000) {
          showToast('Referral bonus must be between 1-1000 coins', 'error');
          return;
        }
        
        // Save to Firebase
        await db.collection('settings').doc('global').set({
          dailyReward: dailyReward,
          referralBonus: referralBonus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: 'admin'
        }, { merge: true });
        
        showToast(`✅ Settings updated successfully! Daily: ${dailyReward}, Referral: ${referralBonus}`, 'success');
        console.log('✅ Settings saved successfully');
        
      } catch (error) {
        console.error('Error updating settings:', error);
        showToast('Error updating settings: ' + error.message, 'error');
      }
    }

    // Send Global Notification - Real Implementation
    async function sendNotificationToAll() {
      const message = prompt('Enter notification message for all users:');
      if (!message || message.trim() === '') return;
      
      try {
        console.log('📢 Sending global notification...');
        showToast('Sending notification to all users...', 'info');
        
        // Save notification to Firebase
        const notificationData = {
          message: message.trim(),
          type: 'global',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: 'admin',
          active: true
        };
        
        await db.collection('notifications').add(notificationData);
        
        // Also save to a global announcements collection for persistent display
        await db.collection('announcements').add({
          ...notificationData,
          priority: 'high'
        });
        
        showToast(`✅ Global notification sent: "${message}"`, 'success');
        console.log('✅ Global notification sent successfully');
        
      } catch (error) {
        console.error('Error sending notification:', error);
        showToast('Error sending notification: ' + error.message, 'error');
      }
    }

    // Reset Database (Dangerous)
    function resetDatabase() {
      const confirmation = prompt('Type "RESET" to confirm database reset (THIS WILL DELETE ALL DATA):');
      if (confirmation === 'RESET') {
        showToast('Database reset confirmed! (Feature disabled for safety)', 'error');
      }
    }
  </script>
</body>
</html>